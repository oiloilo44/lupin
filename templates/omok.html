{% extends "base.html" %}
{% from "components/chat.html" import chat_panel, chat_resources, chat_init_script %}

{% block content %}
<div id="nicknameForm" class="nickname-form">
    <h3>오목 게임 참여</h3>
    <p>닉네임을 입력하고 게임에 참여하세요</p>
    <div class="nickname-input-container">
        <input type="text" id="nicknameInput" placeholder="닉네임을 입력하세요" maxlength="10" autocomplete="off">
        <button onclick="joinGame()">게임 참여</button>
    </div>
</div>

<div id="existingGameForm" class="nickname-form" style="display: none;">
    <h3>기존 게임 발견</h3>
    <p>진행 중인 게임이 있습니다. 어떻게 하시겠습니까?</p>
    <div style="display: flex; gap: 10px; justify-content: center;">
        <button onclick="continueExistingGame()" class="primary">이어하기</button>
        <button onclick="startNewGame()" class="secondary">새 게임</button>
    </div>
</div>

<div id="gameArea" style="display: none;">
    <div class="connection-status" id="connectionStatus" style="display: none;">
        <span id="connectionIcon">🔴</span>
        <span id="connectionText">연결 끊김</span>
    </div>
    <div id="gameLayout" style="display: flex; gap: 20px;">
        <div style="flex: 1;" class="board-container">
            <canvas id="omokBoard" width="450" height="450" style="border: 2px solid #333; background: #ffffff; cursor: pointer; touch-action: none;"></canvas>
        </div>

        <div style="width: 220px;" class="info-panels-container">
            <div class="game-info-panel">
                <h4>플레이어</h4>
                <div id="playerList"></div>
            </div>

            <div class="game-info-panel">
                <h4>현재 턴</h4>
                <div id="currentTurn">-</div>
            </div>

            <div class="game-info-panel">
                <h4>게임 정보</h4>
                <div class="game-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="moveCount">0</div>
                        <div class="stat-label">총 수</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="gameTime">00:00</div>
                        <div class="stat-label">경기 시간</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div style="margin-top: 20px;" class="chat-container">
        {{ chat_panel(title="게임 채팅", height="120px") }}
    </div>

    <div class="game-buttons">
        <button onclick="requestUndo()" id="undoButton" disabled>무르기</button>
        <button onclick="requestRestart()" id="restartButton">게임 재시작</button>
        <button onclick="confirmLeaveRoom()">방 나가기</button>
    </div>

    <!-- 모바일 터치 확정 버튼 -->
    <div id="mobileConfirmButtons" class="mobile-confirm-buttons" style="display: none;">
        <button id="confirmMoveButton" class="confirm-button">확정</button>
        <button id="cancelMoveButton" class="cancel-button">취소</button>
    </div>
</div>

<div class="modal-overlay" id="modalOverlay">
    <div class="modal" id="modal">
        <div class="modal-header">
            <h3 class="modal-title" id="modalTitle">제목</h3>
        </div>
        <div class="modal-body" id="modalBody">
            내용
        </div>
        <div class="modal-footer" id="modalFooter">
        </div>
    </div>
</div>

<div class="toast-container" id="toastContainer"></div>
<div class="confetti-container" id="confettiContainer"></div>
{% endblock %}

{% block extra_css %}
{{ chat_resources() }}
<style>

/* 버튼 비활성화 스타일 개선 */
button:disabled {
    opacity: 0.5 !important;
    cursor: not-allowed !important;
    transform: none !important;
}

button:disabled:hover {
    background-color: inherit !important;
    transform: none !important;
}

/* 게임 보드 하이라이트 효과 */
#omokBoard {
    transition: box-shadow 0.3s ease, border-color 0.3s ease;
}

#omokBoard.highlight {
    box-shadow: 0 0 15px rgba(0, 150, 255, 0.3);
    border-color: #0096ff;
}

#omokBoard.invalid-move {
    border-color: #ff4444;
    box-shadow: 0 0 10px rgba(255, 68, 68, 0.5);
}

/* 연결 상태 UI 개선 */
.connection-status {
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 8px 12px;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(10px);
}

.status-icon {
    font-size: 12px;
    animation: pulse 2s infinite;
}

.status-icon.disconnected {
    color: #dc3545;
}

.status-icon.reconnecting {
    color: #ffc107;
    animation: pulse 1s infinite;
}

.status-icon.connecting {
    color: #17a2b8;
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.connection-help {
    color: #666;
    font-size: 11px;
    margin-top: 2px;
    display: block;
}

.reconnect-progress {
    margin-top: 4px;
    width: 100%;
}

.progress-bar {
    width: 100%;
    height: 3px;
    background: rgba(0, 0, 0, 0.1);
    border-radius: 2px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: #ffc107;
    border-radius: 2px;
    transition: width 0.3s ease;
}

.connection-status.disconnected {
    border-color: #dc3545;
    background: rgba(220, 53, 69, 0.05);
}

.connection-status.reconnecting {
    border-color: #ffc107;
    background: rgba(255, 193, 7, 0.05);
}
</style>
{% endblock %}

{% block extra_js %}
{{ chat_init_script() }}
<script src="/static/js/omok.js"></script>
<script>
// 서버에서 전달된 동적 데이터 (snake_case)
window.omokGameConfig = {
    room_id: '{{ room_id }}',
    session_id: '{{ session_id }}',
    game_state: {{ game_state | tojson | safe }},
    player_data: {{ player_data | tojson | safe }}
};

// OmokGameClient 인스턴스 생성 및 초기화
document.addEventListener('DOMContentLoaded', function() {
    // 서버 데이터를 그대로 사용 (필요시 개별 변환)
    const config = window.omokGameConfig;

    window.omokClient = new OmokGameClient(
        config.room_id,
        config.session_id,
        config.game_state,
        config.player_data
    );
    window.omokClient.initialize();
});


</script>
{% endblock %}
