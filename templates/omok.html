{% extends "base.html" %}

{% block content %}
<div id="nicknameForm" class="nickname-form">
    <h3>ì˜¤ëª© ê²Œì„ ì°¸ì—¬</h3>
    <p>ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ê³  ê²Œì„ì— ì°¸ì—¬í•˜ì„¸ìš”</p>
    <input type="text" id="nicknameInput" placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="10">
    <button onclick="joinGame()">ê²Œì„ ì°¸ì—¬</button>
</div>

<div id="gameArea" style="display: none;">
    <div class="game-status" id="gameStatus">í”Œë ˆì´ì–´ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</div>
    
    <div id="gameLayout" style="display: flex; gap: 20px;">
        <div style="flex: 1;">
            <canvas id="omokBoard" width="450" height="450" style="border: 2px solid #333; background: #deb887; cursor: pointer; touch-action: none;"></canvas>
        </div>
        
        <div style="width: 220px;">
            <div class="game-info-panel">
                <h4>í”Œë ˆì´ì–´</h4>
                <div id="playerList"></div>
            </div>
            
            <div class="game-info-panel">
                <h4>í˜„ì¬ í„´</h4>
                <div id="currentTurn">-</div>
            </div>
            
            <div class="game-info-panel">
                <h4>ê²Œì„ ì •ë³´</h4>
                <div class="game-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="moveCount">0</div>
                        <div class="stat-label">ì´ ìˆ˜</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="gameTime">00:00</div>
                        <div class="stat-label">ê²½ê¸° ì‹œê°„</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div style="margin-top: 20px; text-align: center;">
        <button onclick="requestUndo()" id="undoButton" style="padding: 8px 16px; margin: 5px;" disabled>ë¬´ë¥´ê¸°</button>
        <button onclick="requestRestart()" style="padding: 8px 16px; margin: 5px;">ê²Œì„ ì¬ì‹œì‘</button>
        <button onclick="confirmLeaveRoom()" style="padding: 8px 16px; margin: 5px;">ë°© ë‚˜ê°€ê¸°</button>
    </div>
</div>

<!-- ëª¨ë‹¬ ì˜¤ë²„ë ˆì´ -->
<div class="modal-overlay" id="modalOverlay">
    <div class="modal" id="modal">
        <div class="modal-header">
            <h3 class="modal-title" id="modalTitle">ì œëª©</h3>
        </div>
        <div class="modal-body" id="modalBody">
            ë‚´ìš©
        </div>
        <div class="modal-footer" id="modalFooter">
            <!-- ë²„íŠ¼ë“¤ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </div>
    </div>
</div>

<!-- í† ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ -->
<div class="toast-container" id="toastContainer"></div>

<!-- ìƒ‰ì¢…ì´ ì»¨í…Œì´ë„ˆ -->
<div class="confetti-container" id="confettiContainer"></div>
{% endblock %}

{% block extra_js %}
<script>
const canvas = document.getElementById('omokBoard');
const ctx = canvas.getContext('2d');
const roomId = '{{ room_id }}';
let ws = null;
let gameState = {
    board: Array(15).fill(null).map(() => Array(15).fill(0)),
    currentPlayer: 1
};
let myPlayerNumber = null;
let players = [];
let gameEnded = false;
let waitingForRestart = false;
let lastMove = null;
let hoverPosition = null;
let winningLine = null;
let stoneAnimations = new Map();
let gameStats = { moves: 0, startTime: null };
let waitingForUndo = false;
let winnerNumber = null;

// ì˜¤ëª©íŒ ê·¸ë¦¬ê¸°
function drawBoard() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // ë™ì  í¬ê¸° ê³„ì‚°
    const boardSize = Math.min(canvas.width, canvas.height);
    const cellSize = (boardSize - 60) / 14; // ì—¬ë°± 30pxì”© ë¹¼ê³  14ì¹¸ìœ¼ë¡œ ë‚˜ëˆ”
    const margin = (boardSize - cellSize * 14) / 2;
    
    // ë°°ê²½
    ctx.fillStyle = '#deb887';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // ê²©ì ê·¸ë¦¬ê¸°
    ctx.strokeStyle = '#000';
    ctx.lineWidth = Math.max(1, cellSize / 30); // í¬ê¸°ì— ë¹„ë¡€í•œ ì„  êµµê¸°
    
    for (let i = 0; i < 15; i++) {
        // ì„¸ë¡œì„ 
        ctx.beginPath();
        ctx.moveTo(margin + i * cellSize, margin);
        ctx.lineTo(margin + i * cellSize, boardSize - margin);
        ctx.stroke();
        
        // ê°€ë¡œì„ 
        ctx.beginPath();
        ctx.moveTo(margin, margin + i * cellSize);
        ctx.lineTo(boardSize - margin, margin + i * cellSize);
        ctx.stroke();
    }
    
    // ì¤‘ì‹¬ì  ê·¸ë¦¬ê¸°
    const centerPoints = [[7, 7], [3, 3], [3, 11], [11, 3], [11, 11]];
    ctx.fillStyle = '#000';
    centerPoints.forEach(([x, y]) => {
        ctx.beginPath();
        ctx.arc(margin + x * cellSize, margin + y * cellSize, Math.max(2, cellSize / 10), 0, 2 * Math.PI);
        ctx.fill();
    });
    
    // ë§ˆìš°ìŠ¤ ì˜¤ë²„ ë¯¸ë¦¬ë³´ê¸° (ì‹¤ì œ ëŒ ê·¸ë¦¬ê¸° ì „ì—)
    if (hoverPosition && !gameEnded && players.length === 2 && gameState.currentPlayer === myPlayerNumber) {
        const [hx, hy] = hoverPosition;
        if (gameState.board[hy][hx] === 0) {
            const stoneRadius = Math.max(8, cellSize * 0.4);
            ctx.beginPath();
            ctx.arc(margin + hx * cellSize, margin + hy * cellSize, stoneRadius, 0, 2 * Math.PI);
            ctx.fillStyle = gameState.currentPlayer === 1 ? 'rgba(0, 0, 0, 0.3)' : 'rgba(255, 255, 255, 0.5)';
            ctx.fill();
            ctx.strokeStyle = gameState.currentPlayer === 1 ? 'rgba(0, 0, 0, 0.5)' : 'rgba(51, 51, 51, 0.5)';
            ctx.lineWidth = Math.max(1, cellSize / 30);
            ctx.stroke();
        }
    }
    
    // ëŒ ê·¸ë¦¬ê¸°
    const stoneRadius = Math.max(8, cellSize * 0.4);
    for (let y = 0; y < 15; y++) {
        for (let x = 0; x < 15; x++) {
            if (gameState.board[y][x] !== 0) {
                // ëŒ ê·¸ë¦¬ê¸° ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼
                ctx.save();
                
                const centerX = margin + x * cellSize;
                const centerY = margin + y * cellSize;
                
                ctx.beginPath();
                ctx.arc(centerX, centerY, stoneRadius, 0, 2 * Math.PI);
                ctx.fillStyle = gameState.board[y][x] === 1 ? '#000' : '#fff';
                ctx.fill();
                ctx.strokeStyle = '#333';
                ctx.lineWidth = Math.max(1, cellSize / 30);
                ctx.stroke();
                
                // ìµœê·¼ ë‘” ìˆ˜ ê°•ì¡°
                if (lastMove && lastMove.x === x && lastMove.y === y) {
                    ctx.beginPath();
                    ctx.arc(centerX, centerY, stoneRadius * 1.25, 0, 2 * Math.PI);
                    ctx.strokeStyle = '#ff4444';
                    ctx.lineWidth = Math.max(2, cellSize / 15);
                    ctx.stroke();
                }
                
                // ìŠ¹ë¦¬ ë¼ì¸ ê°•ì¡°
                if (winningLine && winningLine.some(pos => pos.x === x && pos.y === y)) {
                    ctx.beginPath();
                    ctx.arc(centerX, centerY, stoneRadius * 1.5, 0, 2 * Math.PI);
                    ctx.strokeStyle = '#ffd700';
                    ctx.lineWidth = Math.max(3, cellSize / 10);
                    ctx.stroke();
                    
                    // ë°˜ì§ì´ëŠ” íš¨ê³¼
                    const time = Date.now();
                    const pulse = Math.sin(time / 200) * 0.3 + 0.7;
                    ctx.beginPath();
                    ctx.arc(centerX, centerY, stoneRadius * pulse, 0, 2 * Math.PI);
                    ctx.fillStyle = gameState.board[y][x] === 1 ? 
                        `rgba(255, 215, 0, ${0.3 * pulse})` : 
                        `rgba(255, 215, 0, ${0.2 * pulse})`;
                    ctx.fill();
                }
                
                ctx.restore();
            }
        }
    }
}

// ìŠ¹ë¦¬ ì¡°ê±´ í™•ì¸ (ìŠ¹ë¦¬ ë¼ì¸ ë°˜í™˜ ì¶”ê°€)
function checkWin(board, x, y, player) {
    const directions = [
        [0, 1], [1, 0], [1, 1], [1, -1]
    ];
    
    for (let [dx, dy] of directions) {
        let count = 1;
        let winLine = [{x, y}];
        
        // í•œ ë°©í–¥ìœ¼ë¡œ í™•ì¸
        for (let i = 1; i < 5; i++) {
            const nx = x + dx * i;
            const ny = y + dy * i;
            if (nx >= 0 && nx < 15 && ny >= 0 && ny < 15 && board[ny][nx] === player) {
                count++;
                winLine.push({x: nx, y: ny});
            } else {
                break;
            }
        }
        
        // ë°˜ëŒ€ ë°©í–¥ìœ¼ë¡œ í™•ì¸
        for (let i = 1; i < 5; i++) {
            const nx = x - dx * i;
            const ny = y - dy * i;
            if (nx >= 0 && nx < 15 && ny >= 0 && ny < 15 && board[ny][nx] === player) {
                count++;
                winLine.unshift({x: nx, y: ny});
            } else {
                break;
            }
        }
        
        if (count >= 5) {
            return winLine.slice(0, 5); // ì •í™•íˆ 5ê°œë§Œ ë°˜í™˜
        }
    }
    
    return null;
}

// ëª¨ë‹¬ ì‹œìŠ¤í…œ
function showModal(title, body, buttons = []) {
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalBody').innerHTML = body;
    
    const footer = document.getElementById('modalFooter');
    footer.innerHTML = '';
    
    buttons.forEach(button => {
        const btn = document.createElement('button');
        btn.className = `modal-button ${button.class || 'secondary'}`;
        btn.textContent = button.text;
        btn.onclick = button.onclick;
        footer.appendChild(btn);
    });
    
    document.getElementById('modalOverlay').classList.add('show');
}

function hideModal() {
    document.getElementById('modalOverlay').classList.remove('show');
}

function showWinModal(winner, isMyWin) {
    const modal = document.getElementById('modal');
    modal.className = 'modal win-modal';
    
    const icon = isMyWin ? 'ğŸ‰' : 'ğŸ˜”';
    const iconClass = isMyWin ? 'victory' : 'defeat';
    const messageClass = isMyWin ? 'victory' : 'defeat';
    const message = isMyWin ? 'ìŠ¹ë¦¬!' : 'íŒ¨ë°°';
    const submessage = isMyWin ? 'ì¶•í•˜í•©ë‹ˆë‹¤!' : 'ë‹¤ìŒì— ë” ì˜í•´ë³´ì„¸ìš”!';
    
    const body = `
        <div class="win-icon ${iconClass}">${icon}</div>
        <div class="win-message ${messageClass}">${message}</div>
        <div class="win-submessage">${submessage}</div>
    `;
    
    showModal('ê²Œì„ ì¢…ë£Œ', body, [
        {
            text: 'í™•ì¸',
            class: 'primary',
            onclick: () => {
                hideModal();
                modal.className = 'modal';
            }
        }
    ]);
}

function showConfirmModal(title, message, onConfirm, onCancel) {
    showModal(title, message, [
        {
            text: 'ì·¨ì†Œ',
            class: 'secondary',
            onclick: () => {
                hideModal();
                if (onCancel) onCancel();
            }
        },
        {
            text: 'í™•ì¸',
            class: 'primary',
            onclick: () => {
                hideModal();
                if (onConfirm) onConfirm();
            }
        }
    ]);
}

function showRestartRequestModal(requesterName) {
    showModal('ê²Œì„ ì¬ì‹œì‘ ìš”ì²­', 
        `${requesterName}ë‹˜ì´ ê²Œì„ ì¬ì‹œì‘ì„ ìš”ì²­í–ˆìŠµë‹ˆë‹¤.<br>ì¬ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, [
        {
            text: 'ê±°ë¶€',
            class: 'secondary',
            onclick: () => {
                hideModal();
                ws.send(JSON.stringify({
                    type: 'restart_response',
                    accepted: false
                }));
            }
        },
        {
            text: 'ë™ì˜',
            class: 'success',
            onclick: () => {
                hideModal();
                ws.send(JSON.stringify({
                    type: 'restart_response',
                    accepted: true
                }));
            }
        }
    ]);
}

// ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ ì¶”ê°€
function handleHover(e) {
    if (!ws || players.length < 2 || gameState.currentPlayer !== myPlayerNumber || gameEnded) {
        hoverPosition = null;
        drawBoard();
        return;
    }
    
    const pos = getEventPosition(e);
    const x = pos.x;
    const y = pos.y;
    
    if (x >= 0 && x < 15 && y >= 0 && y < 15) {
        hoverPosition = [x, y];
        drawBoard();
    }
}

canvas.addEventListener('mousemove', handleHover);
canvas.addEventListener('touchmove', function(e) {
    e.preventDefault();
    handleHover(e);
});

function clearHover() {
    hoverPosition = null;
    drawBoard();
}

canvas.addEventListener('mouseleave', clearHover);
canvas.addEventListener('touchcancel', clearHover);

// í´ë¦­ ë° í„°ì¹˜ ì´ë²¤íŠ¸
function getEventPosition(e) {
    const rect = canvas.getBoundingClientRect();
    const clientX = e.clientX || (e.touches && e.touches[0].clientX);
    const clientY = e.clientY || (e.touches && e.touches[0].clientY);
    
    // ìº”ë²„ìŠ¤ì˜ ì‹¤ì œ í¬ê¸°ì™€ í™”ë©´ í¬ê¸°ì˜ ë¹„ìœ¨ ê³„ì‚°
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    
    // ìŠ¤ì¼€ì¼ë§ì„ ê³ ë ¤í•œ ì¢Œí‘œ ê³„ì‚°
    const canvasX = (clientX - rect.left) * scaleX;
    const canvasY = (clientY - rect.top) * scaleY;
    
    // ë™ì  í¬ê¸° ê³„ì‚° (drawBoard í•¨ìˆ˜ì™€ ë™ì¼)
    const boardSize = Math.min(canvas.width, canvas.height);
    const cellSize = (boardSize - 60) / 14;
    const margin = (boardSize - cellSize * 14) / 2;
    
    return {
        x: Math.round((canvasX - margin) / cellSize),
        y: Math.round((canvasY - margin) / cellSize)
    };
}

function handleGameMove(e) {
    e.preventDefault();
    if (!ws || players.length < 2 || gameState.currentPlayer !== myPlayerNumber || gameEnded) {
        return;
    }
    
    const pos = getEventPosition(e);
    const x = pos.x;
    const y = pos.y;
    
    if (x >= 0 && x < 15 && y >= 0 && y < 15 && gameState.board[y][x] === 0) {
        // ëŒ ë†“ê¸°
        gameState.board[y][x] = myPlayerNumber;
        lastMove = {x, y};
        
        // ì´ ìˆ˜ íšŸìˆ˜ë¥¼ ë³´ë“œì˜ ëŒ ê°œìˆ˜ë¡œ ê³„ì‚°
        gameStats.moves = 0;
        for (let dy = 0; dy < 15; dy++) {
            for (let dx = 0; dx < 15; dx++) {
                if (gameState.board[dy][dx] !== 0) {
                    gameStats.moves++;
                }
            }
        }
        
        // ìŠ¹ë¦¬ í™•ì¸
        const winLine = checkWin(gameState.board, x, y, myPlayerNumber);
        if (winLine) {
            gameEnded = true;
            winningLine = winLine;
            createConfetti(); // ìŠ¹ë¦¬ ì¶•í•˜ íš¨ê³¼
            ws.send(JSON.stringify({
                type: 'game_end',
                winner: myPlayerNumber,
                game_state: gameState,
                last_move: lastMove,
                winning_line: winLine
            }));
            return;
        }
        
        // í„´ ë³€ê²½
        gameState.currentPlayer = gameState.currentPlayer === 1 ? 2 : 1;
        
        // ì„œë²„ì— ì „ì†¡
        ws.send(JSON.stringify({
            type: 'move',
            game_state: gameState,
            last_move: lastMove
        }));
        
        drawBoard();
        updateUI();
        updateUndoButton();
    }
}

canvas.addEventListener('click', handleGameMove);
canvas.addEventListener('touchend', handleGameMove);

function joinGame() {
    const nickname = document.getElementById('nicknameInput').value.trim();
    if (!nickname) {
        showModal('ì•Œë¦¼', 'ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', [
            { text: 'í™•ì¸', class: 'primary', onclick: hideModal }
        ]);
        return;
    }
    
    // WebSocket ì—°ê²°
    const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${wsProtocol}//${window.location.host}/ws/${roomId}`;
    console.log('Connecting to WebSocket:', wsUrl);
    ws = new WebSocket(wsUrl);
    
    ws.onopen = function() {
        console.log('WebSocket connected, sending join message');
        ws.send(JSON.stringify({
            type: 'join',
            nickname: nickname
        }));
    };
    
    ws.onmessage = function(event) {
        const data = JSON.parse(event.data);
        console.log('Received WebSocket message:', data);
        
        if (data.type === 'room_update') {
            players = data.room.players;
            if (myPlayerNumber === null) {
                myPlayerNumber = players.find(p => p.nickname === nickname)?.player_number;
            }
            updateUI();
            
            if (players.length === 1) {
                showToast('ì…ì¥ ì™„ë£Œ', 'ìƒëŒ€ë°©ì„ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤...', 'info', 5000);
                document.getElementById('nicknameForm').style.display = 'none';
                document.getElementById('gameArea').style.display = 'block';
                drawBoard();
            } else if (players.length === 2) {
                // ë‘ ë²ˆì§¸ í”Œë ˆì´ì–´ë„ í™”ë©´ ì „í™˜
                document.getElementById('nicknameForm').style.display = 'none';
                document.getElementById('gameArea').style.display = 'block';
                gameStats.startTime = Date.now();
                showToast('ê²Œì„ ì‹œì‘', 'ëª¨ë“  í”Œë ˆì´ì–´ê°€ ì°¸ì—¬í–ˆìŠµë‹ˆë‹¤. ê²Œì„ì„ ì‹œì‘í•©ë‹ˆë‹¤!', 'success');
                drawBoard();
            }
        } else if (data.type === 'game_update') {
            gameState = data.game_state;
            if (data.last_move) {
                lastMove = data.last_move;
                // ì´ ìˆ˜ íšŸìˆ˜ë¥¼ ë³´ë“œì˜ ëŒ ê°œìˆ˜ë¡œ ê³„ì‚°
                gameStats.moves = 0;
                for (let y = 0; y < 15; y++) {
                    for (let x = 0; x < 15; x++) {
                        if (gameState.board[y][x] !== 0) {
                            gameStats.moves++;
                        }
                    }
                }
            }
            drawBoard();
            updateUI();
            updateUndoButton();
        } else if (data.type === 'game_end') {
            gameEnded = true;
            gameState = data.game_state;
            if (data.last_move) {
                lastMove = data.last_move;
            }
            if (data.winning_line) {
                winningLine = data.winning_line;
            }
            
            // ì´ ìˆ˜ íšŸìˆ˜ë¥¼ ë³´ë“œì˜ ëŒ ê°œìˆ˜ë¡œ ê³„ì‚°
            gameStats.moves = 0;
            for (let y = 0; y < 15; y++) {
                for (let x = 0; x < 15; x++) {
                    if (gameState.board[y][x] !== 0) {
                        gameStats.moves++;
                    }
                }
            }
            
            winnerNumber = data.winner;
            const isMyWin = data.winner === myPlayerNumber;
            if (isMyWin) {
                createConfetti(); // ë‚´ê°€ ì´ê²¼ì„ ë•Œë§Œ ìƒ‰ì¢…ì´ íš¨ê³¼
            }
            
            // ìŠ¹ë¦¬ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
            startWinAnimation();
            
            setTimeout(() => showWinModal(data.winner, isMyWin), 1500);
        } else if (data.type === 'restart_request') {
            const requesterName = players.find(p => p.player_number === data.from)?.nickname || 'ìƒëŒ€ë°©';
            
            if (data.is_requester) {
                // ìš”ì²­ìì—ê²ŒëŠ” ëŒ€ê¸° ë©”ì‹œì§€ í‘œì‹œ
                showModal('ê²Œì„ ì¬ì‹œì‘ ìš”ì²­', 'ìƒëŒ€ë°©ì—ê²Œ ì¬ì‹œì‘ ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤. ì‘ë‹µì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...', [
                    { text: 'í™•ì¸', class: 'primary', onclick: hideModal }
                ]);
            } else {
                // ìƒëŒ€ë°©ì—ê²ŒëŠ” ë™ì˜ ì—¬ë¶€ í™•ì¸
                showRestartRequestModal(requesterName);
            }
        } else if (data.type === 'restart_accepted') {
            gameEnded = false;
            waitingForRestart = false;
            lastMove = null;
            winningLine = null;
            winnerNumber = null;
            gameStats = { moves: 0, startTime: Date.now() };
            gameState = {
                board: Array(15).fill(null).map(() => Array(15).fill(0)),
                currentPlayer: 1
            };
            hideModal(); // ìš”ì²­ìì˜ ëŒ€ê¸° ëª¨ë‹¬ ìë™ ë‹«ê¸°
            drawBoard();
            updateUI();
            showToast('ê²Œì„ ì¬ì‹œì‘', 'ìƒˆë¡œìš´ ê²Œì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        } else if (data.type === 'restart_rejected') {
            waitingForRestart = false;
            showModal('ì•Œë¦¼', 'ìƒëŒ€ë°©ì´ ì¬ì‹œì‘ì„ ê±°ë¶€í–ˆìŠµë‹ˆë‹¤.', [
                { text: 'í™•ì¸', class: 'primary', onclick: hideModal }
            ]);
        } else if (data.type === 'undo_request') {
            const requesterName = players.find(p => p.player_number === data.from)?.nickname || 'ìƒëŒ€ë°©';
            
            if (data.is_requester) {
                // ìš”ì²­ìì—ê²ŒëŠ” ëŒ€ê¸° ë©”ì‹œì§€ í‘œì‹œ
                showModal('ë¬´ë¥´ê¸° ìš”ì²­', 'ìƒëŒ€ë°©ì—ê²Œ ë¬´ë¥´ê¸° ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤. ì‘ë‹µì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...', [
                    { text: 'í™•ì¸', class: 'primary', onclick: hideModal }
                ]);
            } else {
                // ìƒëŒ€ë°©ì—ê²ŒëŠ” ë™ì˜ ì—¬ë¶€ í™•ì¸
                showUndoRequestModal(requesterName);
            }
        } else if (data.type === 'undo_accepted') {
            gameState = data.game_state;
            // ì´ ìˆ˜ íšŸìˆ˜ë¥¼ ë³´ë“œì˜ ëŒ ê°œìˆ˜ë¡œ ë‹¤ì‹œ ê³„ì‚°
            gameStats.moves = 0;
            for (let y = 0; y < 15; y++) {
                for (let x = 0; x < 15; x++) {
                    if (gameState.board[y][x] !== 0) {
                        gameStats.moves++;
                    }
                }
            }
            waitingForUndo = false;
            lastMove = null; // ë¬´ë¥´ê¸° í›„ ë§ˆì§€ë§‰ ìˆ˜ í•˜ì´ë¼ì´íŠ¸ ì œê±°
            hideModal(); // ìš”ì²­ìì˜ ëŒ€ê¸° ëª¨ë‹¬ ìë™ ë‹«ê¸°
            drawBoard();
            updateUI();
            updateUndoButton();
            showToast('ë¬´ë¥´ê¸° ì„±ê³µ', 'ë§ˆì§€ë§‰ ìˆ˜ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        } else if (data.type === 'undo_rejected') {
            waitingForUndo = false;
            showModal('ì•Œë¦¼', 'ìƒëŒ€ë°©ì´ ë¬´ë¥´ê¸°ë¥¼ ê±°ë¶€í–ˆìŠµë‹ˆë‹¤.', [
                { text: 'í™•ì¸', class: 'primary', onclick: hideModal }
            ]);
        } else if (data.type === 'error') {
            showModal('ì˜¤ë¥˜', data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', [
                { text: 'í™•ì¸', class: 'primary', onclick: () => {
                    hideModal();
                    window.location.href = '/';
                }}
            ]);
        }
    };
    
    ws.onclose = function(event) {
        console.log('WebSocket closed:', event);
        // ì •ìƒì ì¸ ì¢…ë£Œê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
        if (event.code !== 1000) {
            showModal('ì—°ê²° ëŠê¹€', 'ì„œë²„ì™€ì˜ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.<br>ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.', [
                { text: 'ë‹¤ì‹œ ì—°ê²°', class: 'primary', onclick: () => {
                    hideModal();
                    location.reload();
                }},
                { text: 'ë©”ì¸ìœ¼ë¡œ', class: 'secondary', onclick: () => {
                    hideModal();
                    window.location.href = '/';
                }}
            ]);
        }
    };

    ws.onerror = function(error) {
        console.error('WebSocket error:', error);
        showModal('ì—°ê²° ì˜¤ë¥˜', 'ì„œë²„ ì—°ê²°ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', [
            { text: 'í™•ì¸', class: 'primary', onclick: hideModal }
        ]);
    };
}

function updateUI() {
    // í”Œë ˆì´ì–´ ëª©ë¡ ì—…ë°ì´íŠ¸
    const playerList = document.getElementById('playerList');
    playerList.innerHTML = players.map(p => {
        const isCurrentPlayer = p.player_number === gameState.currentPlayer;
        const isMe = p.player_number === myPlayerNumber;
        let itemClass = 'player-item';
        if (isCurrentPlayer) itemClass += ' active';
        if (isMe && isCurrentPlayer) itemClass += ' my-turn';
        
        return `
            <div class="${itemClass}">
                <div class="player-name">${p.nickname}${isMe ? ' (ë‚˜)' : ''}</div>
                <div class="player-stone">
                    <span class="stone-indicator ${p.player_number === 1 ? 'black' : 'white'}"></span>
                    ${p.player_number === 1 ? 'í‘ëŒ' : 'ë°±ëŒ'}
                </div>
            </div>
        `;
    }).join('');
    
    // í˜„ì¬ í„´ í‘œì‹œ
    const currentTurn = document.getElementById('currentTurn');
    const currentPlayer = players.find(p => p.player_number === gameState.currentPlayer);
    if (currentPlayer) {
        const isMyTurn = currentPlayer.player_number === myPlayerNumber;
        currentTurn.innerHTML = `
            <div class="player-item ${isMyTurn ? 'my-turn' : 'active'}">
                <div class="player-name">${currentPlayer.nickname}${isMyTurn ? ' (ë‚˜)' : ''}</div>
                <div class="player-stone">
                    <span class="stone-indicator ${currentPlayer.player_number === 1 ? 'black' : 'white'}"></span>
                    ${currentPlayer.player_number === 1 ? 'í‘ëŒ' : 'ë°±ëŒ'}
                </div>
            </div>
        `;
    } else {
        currentTurn.textContent = '-';
    }
    
    // ê²Œì„ ì •ë³´ ì—…ë°ì´íŠ¸
    document.getElementById('moveCount').textContent = gameStats.moves;
    
    if (gameStats.startTime) {
        const elapsed = Math.floor((Date.now() - gameStats.startTime) / 1000);
        const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
        const seconds = (elapsed % 60).toString().padStart(2, '0');
        document.getElementById('gameTime').textContent = `${minutes}:${seconds}`;
    }
    
    // ê²Œì„ ìƒíƒœ ì—…ë°ì´íŠ¸
    const gameStatus = document.getElementById('gameStatus');
    if (players.length === 0) {
        gameStatus.textContent = 'ê²Œì„ ì—°ê²° ì¤‘...';
        gameStatus.className = 'game-status waiting';
    } else if (players.length === 1) {
        const waitingPlayer = players[0];
        const isMe = waitingPlayer.player_number === myPlayerNumber;
        if (isMe) {
            gameStatus.textContent = 'ìƒëŒ€ë°©ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘... (ë§í¬ë¥¼ ê³µìœ í•˜ì„¸ìš”)';
        } else {
            gameStatus.textContent = 'ë‹¤ë¥¸ í”Œë ˆì´ì–´ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...';
        }
        gameStatus.className = 'game-status waiting';
    } else if (gameEnded) {
        const winnerName = players.find(p => p.player_number === winnerNumber)?.nickname || 'ìŠ¹ì';
        gameStatus.textContent = `ê²Œì„ ì¢…ë£Œ - ${winnerName} ìŠ¹ë¦¬!`;
        gameStatus.className = 'game-status ended';
    } else {
        gameStatus.textContent = 'ê²Œì„ ì§„í–‰ ì¤‘';
        gameStatus.className = 'game-status playing';
    }
}

function requestRestart() {
    if (!ws || waitingForRestart) {
        return;
    }
    
    if (!gameEnded) {
        showModal('ì•Œë¦¼', 'ê²Œì„ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. ê²Œì„ì´ ëë‚œ í›„ ì¬ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', [
            { text: 'í™•ì¸', class: 'primary', onclick: hideModal }
        ]);
        return;
    }
    
    waitingForRestart = true;
    ws.send(JSON.stringify({
        type: 'restart_request',
        from: myPlayerNumber
    }));
}

function requestUndo() {
    if (!ws || waitingForUndo || gameEnded || gameStats.moves === 0) {
        return;
    }
    
    if (gameState.currentPlayer === myPlayerNumber) {
        showModal('ì•Œë¦¼', 'ìì‹ ì˜ í„´ì—ëŠ” ë¬´ë¥´ê¸°ë¥¼ ìš”ì²­í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', [
            { text: 'í™•ì¸', class: 'primary', onclick: hideModal }
        ]);
        return;
    }
    
    waitingForUndo = true;
    ws.send(JSON.stringify({
        type: 'undo_request',
        from: myPlayerNumber
    }));
}

function showUndoRequestModal(requesterName) {
    showModal('ë¬´ë¥´ê¸° ìš”ì²­', 
        `${requesterName}ë‹˜ì´ ë¬´ë¥´ê¸°ë¥¼ ìš”ì²­í–ˆìŠµë‹ˆë‹¤.<br>ë§ˆì§€ë§‰ ìˆ˜ë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, [
        {
            text: 'ê±°ë¶€',
            class: 'secondary',
            onclick: () => {
                hideModal();
                ws.send(JSON.stringify({
                    type: 'undo_response',
                    accepted: false
                }));
            }
        },
        {
            text: 'ë™ì˜',
            class: 'success',
            onclick: () => {
                hideModal();
                ws.send(JSON.stringify({
                    type: 'undo_response',
                    accepted: true
                }));
            }
        }
    ]);
}

function updateUndoButton() {
    const undoButton = document.getElementById('undoButton');
    if (undoButton) {
        const canUndo = ws && !gameEnded && !waitingForUndo && 
                       gameStats.moves > 0 && gameState.currentPlayer !== myPlayerNumber;
        undoButton.disabled = !canUndo;
        undoButton.style.opacity = canUndo ? '1' : '0.5';
    }
}

function confirmLeaveRoom() {
    showConfirmModal(
        'ë°© ë‚˜ê°€ê¸°',
        'ì •ë§ë¡œ ê²Œì„ì—ì„œ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?<br>ì§„í–‰ ì¤‘ì¸ ê²Œì„ì´ ì¢…ë£Œë©ë‹ˆë‹¤.',
        () => {
            if (ws) {
                ws.close();
            }
            window.location.href = '/';
        }
    );
}

// í† ìŠ¤íŠ¸ ì•Œë¦¼ ì‹œìŠ¤í…œ
function showToast(title, message, type = 'info', duration = 3000) {
    const toastContainer = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    
    toast.innerHTML = `
        <div class="toast-title">${title}</div>
        <div class="toast-message">${message}</div>
    `;
    
    toastContainer.appendChild(toast);
    
    // ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
    setTimeout(() => toast.classList.add('show'), 100);
    
    // ìë™ ì œê±°
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }, duration);
}

// ìƒ‰ì¢…ì´ íš¨ê³¼
function createConfetti() {
    const container = document.getElementById('confettiContainer');
    const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#f0932b', '#eb4d4b', '#6c5ce7'];
    
    for (let i = 0; i < 50; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = Math.random() * 100 + '%';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.animationDelay = Math.random() * 3 + 's';
        confetti.style.animationDuration = (Math.random() * 3 + 2) + 's';
        container.appendChild(confetti);
        
        // ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í›„ ì œê±°
        setTimeout(() => {
            if (confetti.parentNode) {
                confetti.parentNode.removeChild(confetti);
            }
        }, 5000);
    }
}

// ìŠ¹ë¦¬ ì• ë‹ˆë©”ì´ì…˜ í•¨ìˆ˜
function startWinAnimation() {
    let animationFrame = 0;
    const animate = () => {
        drawBoard();
        animationFrame++;
        if (animationFrame < 100) {
            requestAnimationFrame(animate);
        }
    };
    animate();
}

// ê²Œì„ ì‹œê°„ ì—…ë°ì´íŠ¸ íƒ€ì´ë¨¸
let gameTimer = null;

function startGameTimer() {
    if (gameTimer) clearInterval(gameTimer);
    gameTimer = setInterval(() => {
        if (gameStats.startTime && !gameEnded) {
            updateUI();
        }
    }, 1000);
}

function stopGameTimer() {
    if (gameTimer) {
        clearInterval(gameTimer);
        gameTimer = null;
    }
}

// ëª¨ë°”ì¼ ë ˆì´ì•„ì›ƒ ì¡°ì •
function adjustMobileLayout() {
    const gameLayout = document.getElementById('gameLayout');
    const canvas = document.getElementById('omokBoard');
    
    if (!canvas) return; // ìº”ë²„ìŠ¤ê°€ ì—†ìœ¼ë©´ ë¦¬í„´
    
    if (window.innerWidth <= 768) {
        gameLayout.style.flexDirection = 'column';
        gameLayout.style.gap = '15px';
        
        // ìº”ë²„ìŠ¤ í¬ê¸° ì¡°ì • - transform ëŒ€ì‹  ì‹¤ì œ í¬ê¸° ë³€ê²½
        const size = Math.min(window.innerWidth - 60, 320);
        canvas.style.width = size + 'px';
        canvas.style.height = size + 'px';
        canvas.width = size;
        canvas.height = size;
        
        // transform ì œê±° (ë” ì •í™•í•œ ì¢Œí‘œ ê³„ì‚°ì„ ìœ„í•´)
        canvas.style.transform = '';
        canvas.style.transformOrigin = '';
        
        drawBoard();
    } else {
        gameLayout.style.flexDirection = 'row';
        gameLayout.style.gap = '20px';
        
        canvas.style.width = '450px';
        canvas.style.height = '450px';
        canvas.width = 450;
        canvas.height = 450;
        canvas.style.transform = '';
        canvas.style.transformOrigin = '';
        
        drawBoard();
    }
}

window.addEventListener('resize', adjustMobileLayout);
window.addEventListener('orientationchange', function() {
    setTimeout(adjustMobileLayout, 100);
});

// ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë‹‰ë„¤ì„ ìë™ ì…ë ¥
function checkHostNickname() {
    const hostNickname = sessionStorage.getItem('hostNickname');
    if (hostNickname) {
        const nicknameInput = document.getElementById('nicknameInput');
        if (nicknameInput) {
            nicknameInput.value = hostNickname;
            // ë°© ìƒì„±ìì´ë¯€ë¡œ ë°”ë¡œ ê²Œì„ì— ì°¸ì—¬
            setTimeout(() => {
                showToast('ìë™ ì…ì¥', 'ë°© ìƒì„±ìë¡œ ê²Œì„ì— ì…ì¥í•©ë‹ˆë‹¤...', 'info', 2000);
                setTimeout(joinGame, 1000);
            }, 500);
        }
        // ì‚¬ìš© í›„ ì œê±°
        sessionStorage.removeItem('hostNickname');
    }
}

// ì´ˆê¸°í™”
drawBoard();
startGameTimer();
adjustMobileLayout();
checkHostNickname();
</script>
{% endblock %}