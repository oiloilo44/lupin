{% extends "base.html" %}
{% from "components/chat.html" import chat_panel, chat_resources, chat_init_script %}

{% block content %}
<div id="nicknameForm" class="nickname-form">
    <h3>ì˜¤ëª© ê²Œì„ ì°¸ì—¬</h3>
    <p>ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ê³  ê²Œì„ì— ì°¸ì—¬í•˜ì„¸ìš”</p>
    <div class="nickname-input-container">
        <input type="text" id="nicknameInput" placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="10" autocomplete="off">
        <button onclick="joinGame()">ê²Œì„ ì°¸ì—¬</button>
    </div>
</div>

<div id="existingGameForm" class="nickname-form" style="display: none;">
    <h3>ê¸°ì¡´ ê²Œì„ ë°œê²¬</h3>
    <p>ì§„í–‰ ì¤‘ì¸ ê²Œì„ì´ ìˆìŠµë‹ˆë‹¤. ì–´ë–»ê²Œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
    <div style="display: flex; gap: 10px; justify-content: center;">
        <button onclick="continueExistingGame()" class="primary">ì´ì–´í•˜ê¸°</button>
        <button onclick="startNewGame()" class="secondary">ìƒˆ ê²Œì„</button>
    </div>
</div>

<div id="gameArea" style="display: none;">
    <div class="connection-status" id="connectionStatus" style="display: none;">
        <span id="connectionIcon">ğŸ”´</span>
        <span id="connectionText">ì—°ê²° ëŠê¹€</span>
    </div>
    <div id="gameLayout" style="display: flex; gap: 20px;">
        <div style="flex: 1;" class="board-container">
            <canvas id="omokBoard" width="450" height="450" style="border: 2px solid #333; background: #ffffff; cursor: pointer; touch-action: none;"></canvas>
        </div>

        <div style="width: 220px;" class="info-panels-container">
            <div class="game-info-panel">
                <h4>í”Œë ˆì´ì–´</h4>
                <div id="playerList"></div>
            </div>

            <div class="game-info-panel">
                <h4>í˜„ì¬ í„´</h4>
                <div id="currentTurn">-</div>
            </div>

            <div class="game-info-panel">
                <h4>ê²Œì„ ì •ë³´</h4>
                <div class="game-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="moveCount">0</div>
                        <div class="stat-label">ì´ ìˆ˜</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="gameTime">00:00</div>
                        <div class="stat-label">ê²½ê¸° ì‹œê°„</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div style="margin-top: 20px;" class="chat-container">
        {{ chat_panel(title="ê²Œì„ ì±„íŒ…", height="120px") }}
    </div>

    <div class="game-buttons">
        <button onclick="requestUndo()" id="undoButton" disabled>ë¬´ë¥´ê¸°</button>
        <button onclick="requestRestart()" id="restartButton">ê²Œì„ ì¬ì‹œì‘</button>
        <button onclick="confirmLeaveRoom()">ë°© ë‚˜ê°€ê¸°</button>
    </div>

    <!-- ëª¨ë°”ì¼ í„°ì¹˜ í™•ì • ë²„íŠ¼ -->
    <div id="mobileConfirmButtons" class="mobile-confirm-buttons" style="display: none;">
        <button id="confirmMoveButton" class="confirm-button">í™•ì •</button>
        <button id="cancelMoveButton" class="cancel-button">ì·¨ì†Œ</button>
    </div>
</div>

<div class="modal-overlay" id="modalOverlay">
    <div class="modal" id="modal">
        <div class="modal-header">
            <h3 class="modal-title" id="modalTitle">ì œëª©</h3>
        </div>
        <div class="modal-body" id="modalBody">
            ë‚´ìš©
        </div>
        <div class="modal-footer" id="modalFooter">
        </div>
    </div>
</div>

<div class="toast-container" id="toastContainer"></div>
<div class="confetti-container" id="confettiContainer"></div>
{% endblock %}

{% block extra_css %}
{{ chat_resources() }}
<style>

/* ë²„íŠ¼ ë¹„í™œì„±í™” ìŠ¤íƒ€ì¼ ê°œì„  */
button:disabled {
    opacity: 0.5 !important;
    cursor: not-allowed !important;
    transform: none !important;
}

button:disabled:hover {
    background-color: inherit !important;
    transform: none !important;
}

/* ê²Œì„ ë³´ë“œ í•˜ì´ë¼ì´íŠ¸ íš¨ê³¼ */
#omokBoard {
    transition: box-shadow 0.3s ease, border-color 0.3s ease;
}

#omokBoard.highlight {
    box-shadow: 0 0 15px rgba(0, 150, 255, 0.3);
    border-color: #0096ff;
}

#omokBoard.invalid-move {
    border-color: #ff4444;
    box-shadow: 0 0 10px rgba(255, 68, 68, 0.5);
}

/* ì—°ê²° ìƒíƒœ UI ê°œì„  */
.connection-status {
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 8px 12px;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(10px);
}

.status-icon {
    font-size: 12px;
    animation: pulse 2s infinite;
}

.status-icon.disconnected {
    color: #dc3545;
}

.status-icon.reconnecting {
    color: #ffc107;
    animation: pulse 1s infinite;
}

.status-icon.connecting {
    color: #17a2b8;
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.connection-help {
    color: #666;
    font-size: 11px;
    margin-top: 2px;
    display: block;
}

.reconnect-progress {
    margin-top: 4px;
    width: 100%;
}

.progress-bar {
    width: 100%;
    height: 3px;
    background: rgba(0, 0, 0, 0.1);
    border-radius: 2px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: #ffc107;
    border-radius: 2px;
    transition: width 0.3s ease;
}

.connection-status.disconnected {
    border-color: #dc3545;
    background: rgba(220, 53, 69, 0.05);
}

.connection-status.reconnecting {
    border-color: #ffc107;
    background: rgba(255, 193, 7, 0.05);
}
</style>
{% endblock %}

{% block extra_js %}
{{ chat_init_script() }}
<script src="/static/js/omok.js"></script>
<script>
// ì„œë²„ì—ì„œ ì „ë‹¬ëœ ë™ì  ë°ì´í„° (snake_case)
window.omokGameConfig = {
    room_id: '{{ room_id }}',
    session_id: '{{ session_id }}',
    game_state: {{ game_state | tojson | safe }},
    player_data: {{ player_data | tojson | safe }}
};

// OmokGameClient ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ë° ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    // ì„œë²„ ë°ì´í„°ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš© (í•„ìš”ì‹œ ê°œë³„ ë³€í™˜)
    const config = window.omokGameConfig;

    window.omokClient = new OmokGameClient(
        config.room_id,
        config.session_id,
        config.game_state,
        config.player_data
    );
    window.omokClient.initialize();
});


</script>
{% endblock %}
