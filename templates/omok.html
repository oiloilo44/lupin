{% extends "base.html" %}
{% from "components/chat.html" import chat_panel, chat_resources, chat_init_script %}

{% block content %}
<div id="nicknameForm" class="nickname-form">
    <h3>오목 게임 참여</h3>
    <p>닉네임을 입력하고 게임에 참여하세요</p>
    <input type="text" id="nicknameInput" placeholder="닉네임을 입력하세요" maxlength="10">
    <button onclick="joinGame()">게임 참여</button>
</div>

<div id="existingGameForm" class="nickname-form" style="display: none;">
    <h3>기존 게임 발견</h3>
    <p>진행 중인 게임이 있습니다. 어떻게 하시겠습니까?</p>
    <div style="display: flex; gap: 10px; justify-content: center;">
        <button onclick="continueExistingGame()" class="primary">이어하기</button>
        <button onclick="startNewGame()" class="secondary">새 게임</button>
    </div>
</div>

<div id="gameArea" style="display: none;">
    <div class="connection-status" id="connectionStatus" style="display: none;">
        <span id="connectionIcon">🔴</span>
        <span id="connectionText">연결 끊김</span>
    </div>
    
    <div id="gameLayout" style="display: flex; gap: 20px;">
        <div style="flex: 1;">
            <canvas id="omokBoard" width="450" height="450" style="border: 2px solid #333; background: #ffffff; cursor: pointer; touch-action: none;"></canvas>
        </div>
        
        <div style="width: 180px;">
            <div class="game-info-panel">
                <h4>플레이어</h4>
                <div id="playerList"></div>
            </div>
            
            <div class="game-info-panel">
                <h4>현재 턴</h4>
                <div id="currentTurn">-</div>
            </div>
            
            <div class="game-info-panel">
                <h4>게임 정보</h4>
                <div class="game-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="moveCount">0</div>
                        <div class="stat-label">총 수</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="gameTime">00:00</div>
                        <div class="stat-label">경기 시간</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div style="margin-top: 20px; max-width: 600px;">
        {{ chat_panel(title="게임 채팅", height="120px") }}
    </div>
    
    <div style="margin-top: 15px; text-align: center;">
        <button onclick="requestUndo()" id="undoButton" style="padding: 8px 16px; margin: 5px;" disabled>무르기</button>
        <button onclick="requestRestart()" id="restartButton" style="padding: 8px 16px; margin: 5px;">게임 재시작</button>
        <button onclick="confirmLeaveRoom()" style="padding: 8px 16px; margin: 5px;">방 나가기</button>
    </div>
</div>

<div class="modal-overlay" id="modalOverlay">
    <div class="modal" id="modal">
        <div class="modal-header">
            <h3 class="modal-title" id="modalTitle">제목</h3>
        </div>
        <div class="modal-body" id="modalBody">
            내용
        </div>
        <div class="modal-footer" id="modalFooter">
        </div>
    </div>
</div>

<div class="toast-container" id="toastContainer"></div>
<div class="confetti-container" id="confettiContainer"></div>
{% endblock %}

{% block extra_css %}
{{ chat_resources() }}
<style>

/* 버튼 비활성화 스타일 개선 */
button:disabled {
    opacity: 0.5 !important;
    cursor: not-allowed !important;
    transform: none !important;
}

button:disabled:hover {
    background-color: inherit !important;
    transform: none !important;
}

/* 게임 보드 하이라이트 효과 */
#omokBoard {
    transition: box-shadow 0.3s ease, border-color 0.3s ease;
}

#omokBoard.highlight {
    box-shadow: 0 0 15px rgba(0, 150, 255, 0.3);
    border-color: #0096ff;
}

#omokBoard.invalid-move {
    border-color: #ff4444;
    box-shadow: 0 0 10px rgba(255, 68, 68, 0.5);
}
</style>
{% endblock %}

{% block extra_js %}
{{ chat_init_script() }}
<script src="/static/js/omok.js"></script>
<script>
// 서버에서 전달된 동적 데이터
window.omokGameConfig = {
    roomId: '{{ room_id }}',
    sessionId: '{{ session_id }}',
    gameState: {{ game_state | tojson | safe }},
    playerData: {{ player_data | tojson | safe }}
};

// OmokGameClient 인스턴스 생성 및 초기화
document.addEventListener('DOMContentLoaded', function() {
    window.omokClient = new OmokGameClient(
        window.omokGameConfig.roomId,
        window.omokGameConfig.sessionId,
        window.omokGameConfig.gameState,
        window.omokGameConfig.playerData
    );
    window.omokClient.initialize();
});
</script>
{% endblock %}